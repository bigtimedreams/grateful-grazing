<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Content Manager</title>
    <meta name="robots" content="noindex" />

    <!-- Point Decap to your config -->
    <link rel="cms-config-url" href="/admin/config.yml" type="text/yaml" />

    <!-- Netlify Identity (login widget) -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <!-- Prevent auto-init; we’ll initialize explicitly -->
    <script>window.CMS_MANUAL_INIT = true;</script>

    <!-- Decap CMS app -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

    <!-- Friendly preview UI (safe: if these fail, CMS still loads) -->
    <link rel="stylesheet" href="/admin/preview.css" />
    <script src="/admin/previews.js" defer></script>

    <!-- Floating “Publish checklist” -->
    <script src="/admin/enhance.js" defer></script>

    <style>
        html,
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
            background: #f7f7fb;
        }
    </style>
</head>

<body>
    <script>
        // Refresh after login so Git Gateway has a token
        if (window.netlifyIdentity) {
            window.netlifyIdentity.on("init", (user) => {
                if (!user) window.netlifyIdentity.on("login", () => location.reload());
            });
        }

        // Manual, robust CMS init (handles script race conditions)
        function bootCMS(attempt) {
            try {
                if (!window.CMS) throw new Error("CMS not loaded yet");
                CMS.init({ configPath: "/admin/config.yml" });
            } catch (err) {
                if (!attempt) return setTimeout(() => bootCMS(1), 300);
                console.error("CMS init error:", err);
            }
        }
        bootCMS(0);
    </script>
</body>

</html>