<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Grateful Grazing — Content Manager</title>
    <meta name="robots" content="noindex" />

    <!-- Tell CMS where config.yml is -->
    <link rel="cms-config-url" href="/admin/config.yml" type="text/yaml" />

    <!-- Netlify Identity for login -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <!-- Decap CMS -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>

    <!-- Preview styles -->
    <style>
        :root {
            --ink: #111;
            --muted: #666;
            --bg: #f8f8fa;
            --border: #e0e0e0;
        }

        html,
        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
            background: var(--bg);
            color: var(--ink);
        }

        .cms-card {
            max-width: 800px;
            margin: 20px auto;
            background: white;
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .cms-card img {
            width: 100%;
            display: block;
            object-fit: cover;
        }

        .cms-pad {
            padding: 16px 20px;
        }

        .cms-title {
            font-size: 20px;
            font-weight: 600;
            margin: 0 0 6px;
        }

        .cms-meta {
            font-size: 14px;
            color: var(--muted);
            margin-bottom: 10px;
        }

        .cms-text {
            font-size: 15px;
            line-height: 1.5;
        }
    </style>
</head>

<body>
    <script>
        // Redirect to reload after login
        if (window.netlifyIdentity) {
            window.netlifyIdentity.on("init", (user) => {
                if (!user) {
                    window.netlifyIdentity.on("login", () => document.location.reload());
                }
            });
        }

        // MENU PREVIEW
        const MenuPreview = createClass({
            render() {
                const e = this.props.entry;
                const get = (field) => e.getIn(["data", field]) || "";
                const img = this.props.getAsset(get("about_image")) || this.props.getAsset(get("image"));
                return h("article", { className: "cms-card" },
                    img ? h("img", { src: img.toString(), alt: get("title") }) : null,
                    h("div", { className: "cms-pad" },
                        h("div", { className: "cms-title" }, get("title")),
                        get("subtitle") ? h("div", { className: "cms-meta" }, get("subtitle")) : null,
                        get("price") ? h("div", { className: "cms-meta" }, get("price")) : null,
                        get("description") ? h("div", { className: "cms-text" }, get("description")) : null
                    )
                );
            }
        });
        CMS.registerPreviewTemplate("menu", MenuPreview);

        // GALLERY PREVIEW
        const GalleryPreview = createClass({
            render() {
                const e = this.props.entry;
                const img = this.props.getAsset(e.getIn(["data", "image"]));
                const caption = e.getIn(["data", "title"]);
                return h("figure", { className: "cms-card" },
                    img ? h("img", { src: img.toString(), alt: caption || "Gallery image" }) : null,
                    caption ? h("figcaption", { className: "cms-pad" }, caption) : null
                );
            }
        });
        CMS.registerPreviewTemplate("gallery", GalleryPreview);

        // TESTIMONIAL PREVIEW
        const TestimonialPreview = createClass({
            render() {
                const e = this.props.entry;
                return h("div", { className: "cms-card cms-pad" },
                    h("div", { className: "cms-title" }, e.getIn(["data", "name"])),
                    h("blockquote", { className: "cms-text" }, `“${e.getIn(["data", "quote"]) || ""}”`)
                );
            }
        });
        CMS.registerPreviewTemplate("testimonials", TestimonialPreview);

        // FAQ PREVIEW
        const FAQPreview = createClass({
            render() {
                const e = this.props.entry;
                return h("div", { className: "cms-card cms-pad" },
                    h("div", { className: "cms-title" }, e.getIn(["data", "question"])),
                    h("div", { className: "cms-text" }, e.getIn(["data", "answer"]))
                );
            }
        });
        CMS.registerPreviewTemplate("faq", FAQPreview);
    </script>
</body>

</html>